@page
@model WebImage.Pages.MyGalleriesModel

@{
    Models.ItemGallery selectedGallery = null;
    var listmygalleries = Model.MyContainer.myGalleries.Gallery.OrderByDescending(x => x.Gallery.DateInsert).ToList();

    if (listmygalleries.Any())
    {
        if (listmygalleries.FirstOrDefault(x => x.IsSelected) == null)
        {
            listmygalleries.First().IsSelected = true;
            selectedGallery = listmygalleries.First();
        }
        else
        {
            selectedGallery = listmygalleries.FirstOrDefault(x => x.IsSelected);
        }
    }
}

<script src="~/vendor/jquery/dist/jquery.js"></script>
<script src="~/vendor/lightgallery/dist/js/lightgallery-all.js"></script>
<link href="~/vendor/lightgallery/dist/css/lightgallery.css" rel="stylesheet" />
<link href="~/vendor/lightgallery/dist/css/lg-transitions.css" rel="stylesheet" />
<link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
<script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>

<style>
    .list-group-item {
        background-color: #343a40;
    }

    .card-body {
        padding: 0px;
    }

        .card-body input {
            width: 100%;
        }

    .card {
        border-color: #8f8f8f;
        padding: 10px;
    }

    .header {
        font-size: 16px;
    }

    .selectedimages {
        height: 500px;
        overflow: auto;
    }

    .row {
        margin-top: 10px;
    }

    span.input-group-text {
        width: 100%;
    }

    .card.selected {
        background-color: #70A1D7;
    }

    #galleryDetail {
        margin-top: 50px;
    }

    .activeslow .toggle-group {
        transition: left 0.7s;
        -webkit-transition: left 0.7s;
    }

    .toggle-handle.btn.btn-default {
        background-color: #DEE2D9;
    }
</style>

@if (listmygalleries.Count > 0)
{
    for (int i = 0; i < listmygalleries.Count; i += 4)
    {
        <div class="row" style="margin-top:10px">
            @for (int j = 0; j < 4; j++)
            {
                if (i + j < listmygalleries.Count)
                {
                    var gallery = listmygalleries[i + j];

                    <div class="col-3">
                        <div class="card @(gallery.IsSelected ? "selected" : "")" style="width: 18rem;">
                            <img class="card-img-top" src="@Model.MyContainer.myImages.GetImage(gallery.GalleryFile[0].FileId).Thumb" alt="@gallery.Gallery.Name">
                            <div class="card-body">
                                <h5 class="card-title">@gallery.Gallery.Name</h5>
                                <h6 class="card-subtitle mb-2 text-muted">Last update: @gallery.Gallery.DateUpdate.ToUniversalTime()</h6>
                                <p class="card-text">@gallery.Gallery.Description</p>
                                <div class="row">
                                    <div class="col-6">
                                        <a class="btn btn-outline-secondary" asp-page="MyGalleries" asp-route-galleryId="@gallery.Gallery.GalleryId">View</a>
                                    </div>
                                    <div class="col-6">
                                        <form asp-page-handler="RemoveGallery" method="post" onclick="return confirm('Are you sure you want to delete this?')">
                                            <a class="btn btn-outline-danger" asp-page-handler="RemoveGallery" asp-route-galleryId="@gallery.Gallery.GalleryId">Remove</a>
                                        </form>
                                    </div>
                                    @*<div class="col-4">
                                            <form asp-page-handler="DisableGallery" method="post">
                                                <a class="btn btn-outline-danger" asp-page-handler="DisableGallery" asp-route-galleryId="@gallery.Gallery.GalleryId">Disable</a>
                                            </form>
                                        </div>*@
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    }
}

@if (selectedGallery != null)
{
<form asp-page-handler="SaveGallery" method="post">
    <div id="galleryDetail">
        <div class="row">
            <div class="col-1">
                <button class="btn btn-outline-light" id="btnsave" asp-page-handler="SaveGallery">Save</button>
            </div>
            <div class="col-1">
                @{
                    var ischecked = (selectedGallery.Gallery.Active) ? "checked" : "";
                }
                <input type="checkbox" id="toggleActive" name="toggleActive" data-toggle="toggle" data-onstyle="success" data-offstyle="danger" data-on="Active" data-off="Not Active" data-style="activeslow" @ischecked>
            </div>
            @*<div class="col-1">
            <form asp-page-handler="RefreshGallery" method="post">
                <button class="btn btn-outline-light" id="btnrefresh" asp-page-handler="RefreshGallery">Refresh</button>
            </form>
        </div>*@
            @*<div class="col-1">
            <form asp-page-handler="RemoveGallery" method="post">
                <button class="btn btn-outline-light" asp-page-handler="RemoveGallery" asp-route-galleryId="@selectedGallery.Gallery.GalleryId">Remove</button>
            </form>
        </div>*@
            <div class="col-10">
                <div class="input-group input-group-sm mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="gallerylastupdate">Url</span>
                    </div>
                    <input type="text" readonly="readonly" class="form-control" id="inputgalleryurl" name="inputgalleryurl" value="@selectedGallery.Gallery.Url">
                    @*<input type="text" readonly="readonly" class="form-control" id="inputgalleryurl" name="inputgalleryurl" value="@System.IO.Path.Combine(host,"api","gallery",selectedGallery.Gallery.GalleryId.ToString())">*@
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-2">
                <div class="input-group input-group-sm mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="gallerylastupdate">Last update</span>
                    </div>
                    <input type="text" readonly="readonly" class="form-control" placeholder="Last Update" aria-label="Small" aria-describedby="gallerylastupdate" value="@selectedGallery.Gallery.DateUpdate.ToUniversalTime()">
                </div>
            </div>
            <div class="col-3">
                <div class="input-group input-group-sm mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="galleryname">Name</span>
                    </div>
                    <input type="text" class="form-control" id="inputgalleryname" name="inputgalleryname" placeholder="Name" aria-label="Small" aria-describedby="galleryname" value="@selectedGallery.Gallery.Name">
                    <input type="hidden" value="@selectedGallery.Gallery.GalleryId" id="galleryid" name="galleryid" />
                    <input type="hidden" id="attrs" name="attrs" />
                    <input type="hidden" id="images" name="images" value="@string.Join(",", selectedGallery.GalleryFile.Select(x => x.FileId))" />
                    <input type="hidden" id="descriptions" name="descriptions" />
                </div>
            </div>
            <div class="col-7">
                <div class="input-group input-group-sm mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="gallerydescription">Description</span>
                    </div>
                    <input type="text" class="form-control" id="inputgallerydescription" name="inputgallerydescription" placeholder="Description" aria-label="Small" aria-describedby="gallerydescription" value="@selectedGallery.Gallery.Description">
                </div>
            </div>
        </div>
        @*<div class="row">
            <div class="col-12">
                <button class="btn btn-outline-light" id="btnsave" asp-page-handler="SaveGallery">Save</button>
            </div>
        </div>*@

        <div class="row">
            <div class="col-2">
                <div class="card selectedimages">
                    <ul class="list-group">
                        @foreach (var item in selectedGallery.GalleryFile)
                        {
                            var image = Model.MyContainer.myImages.GetImage(item.FileId);

                            <li class="list-group-item">
                                <div class="card">
                                    <img class="card-img-top" src="@image.Thumb" alt="@image.Name">
                                    <div class="card-body">
                                        <p class="card-text">
                                            Description:<input type="text" class="card-text imagedescriptions" value="@item.Description" id="Descr_@item.FileId" name="Descr_@item.FileId" />
                                        </p>
                                    </div>
                                </div>
                            </li>
                        }
                    </ul>
                </div>
            </div>
            <div class="col-4">
                <div class="card">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="name" @Model.MyContainer.myGalleries.AttributeChecked(selectedGallery.Gallery.Columns, "name")>
                                <label class="custom-control-label" for="name">Name</label>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="title" @Model.MyContainer.myGalleries.AttributeChecked(selectedGallery.Gallery.Columns, "title")>
                                <label class="custom-control-label" for="title">Title</label>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="format" @Model.MyContainer.myGalleries.AttributeChecked(selectedGallery.Gallery.Columns, "format")>
                                <label class="custom-control-label" for="format">Format</label>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="length" @Model.MyContainer.myGalleries.AttributeChecked(selectedGallery.Gallery.Columns, "length")>
                                <label class="custom-control-label" for="length">Length</label>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="landscape" @Model.MyContainer.myGalleries.AttributeChecked(selectedGallery.Gallery.Columns, "landscape")>
                                <label class="custom-control-label" for="landscape">Landscape</label>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="pixel" @Model.MyContainer.myGalleries.AttributeChecked(selectedGallery.Gallery.Columns, "pixel")>
                                <label class="custom-control-label" for="pixel">Pixel</label>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="size" @Model.MyContainer.myGalleries.AttributeChecked(selectedGallery.Gallery.Columns, "size")>
                                <label class="custom-control-label" for="size">Size</label>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="resolution" @Model.MyContainer.myGalleries.AttributeChecked(selectedGallery.Gallery.Columns, "resolution")>
                                <label class="custom-control-label" for="resolution">Resolution</label>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="url" @Model.MyContainer.myGalleries.AttributeChecked(selectedGallery.Gallery.Columns, "url")>
                                <label class="custom-control-label" for="url">Url</label>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="content" @Model.MyContainer.myGalleries.AttributeChecked(selectedGallery.Gallery.Columns, "content")>
                                <label class="custom-control-label" for="content">Content (heavier)</label>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="col-6">
                <div class="card">
                    <textarea readonly="readonly" name="jsonPreview" id="jsonPreview" cols="100" rows="30"></textarea>
                </div>
            </div>
        </div>
    </div>
</form>

}

<script>
    $(document).ready(function () {

        $("#attrs").val(attrs());
        $("#descriptions").val(descrs());

        @{
            var galleryId = 0;

            if (selectedGallery!=null)
                galleryId=selectedGallery.Gallery.GalleryId;
        }

        $.ajax({
            type: 'POST',
            url: "/api/gallery/@galleryId",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (data) {
                $('#jsonPreview').text(JSON.stringify(data, undefined, 2));
            },
            error: function (xhr) {
                $('#jsonPreview').text('Request Status: ' + xhr.status + ' Status Text: ' + xhr.statusText + ' ' + xhr.responseText);
            }
        });

        $("#btnrefresh").click(function () {
             $("#descriptions").val(descrs());
             $("#attrs").val(attrs());
            //var attributes = hideAttrs("name") + hideAttrs("title") + hideAttrs("format") + hideAttrs("length") + hideAttrs("landscape") +  hideAttrs("pixel") + hideAttrs("size") + hideAttrs("resolution") + hideAttrs("url") + hideAttrs("content");

            //window.location.href = '@Url.Page("MyGalleries")?galleryId=@galleryId&attr=' + btoa(attributes.substr(0, attributes.length - 1)) + "&descrs=" + descrs();
        });

        $("#btnsave").click(function () {
            $("#attrs").val(attrs());
            $("#descriptions").val(descrs());
        });


        $(".custom-control-input").click(function () {
            $("#attrs").val(attrs());
        });

    });


    function descrs()
    {
        var descriptions = "";
        $(".imagedescriptions").each(function () {
            descriptions += $(this).val() + "-" + $(this).attr("id").replace("Descr_","") + ",";
        });

        if (descriptions.length>0)
            descriptions = descriptions.substr(0, descriptions.length - 1);

        return descriptions;
    }


    function attrs() {
        var attributes = hideAttrs("name") + hideAttrs("title") + hideAttrs("format") + hideAttrs("length") + hideAttrs("landscape") + hideAttrs("pixel") + hideAttrs("size") + hideAttrs("resolution") + hideAttrs("url") + hideAttrs("content");
        return attributes;
    }

    function hideAttrs(id)
    {
        if ($("#" + id).prop("checked") == true)
            return "";
        else
            return id  + ",";
    }

</script>

